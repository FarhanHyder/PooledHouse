{"ast":null,"code":"\"use strict\";\n/*\n * Copyright 2017-2017 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"). You may not use this file except in compliance with\n * the License. A copy of the License is located at\n *\n *     http://aws.amazon.com/apache2.0/\n *\n * or in the \"license\" file accompanying this file. This file is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR\n * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\n * and limitations under the License.\n */\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = Object.setPrototypeOf || {\n    __proto__: []\n  } instanceof Array && function (d, b) {\n    d.__proto__ = b;\n  } || function (d, b) {\n    for (var p in b) {\n      if (b.hasOwnProperty(p)) d[p] = b[p];\n    }\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar React = require(\"react\");\n\nvar react_1 = require(\"react\");\n\nvar core_1 = require(\"@aws-amplify/core\");\n\nvar auth_1 = require(\"@aws-amplify/auth\");\n\nvar Amplify_UI_Theme_1 = require(\"../Amplify-UI/Amplify-UI-Theme\");\n\nvar Amplify_UI_Components_React_1 = require(\"../Amplify-UI/Amplify-UI-Components-React\");\n\nvar ui_1 = require(\"@aws-amplify/ui\");\n\nvar QRCode = require('qrcode.react');\n\nvar logger = new core_1.ConsoleLogger('TOTPSetupComp');\n\nvar TOTPSetupComp =\n/** @class */\nfunction (_super) {\n  __extends(TOTPSetupComp, _super);\n\n  function TOTPSetupComp(props) {\n    var _this = _super.call(this, props) || this;\n\n    _this.setup = _this.setup.bind(_this);\n    _this.showSecretCode = _this.showSecretCode.bind(_this);\n    _this.verifyTotpToken = _this.verifyTotpToken.bind(_this);\n    _this.handleInputChange = _this.handleInputChange.bind(_this);\n    _this.triggerTOTPEvent = _this.triggerTOTPEvent.bind(_this);\n    _this.state = {\n      code: null,\n      setupMessage: null\n    };\n    return _this;\n  }\n\n  TOTPSetupComp.prototype.componentDidMount = function () {\n    this.setup();\n  };\n\n  TOTPSetupComp.prototype.triggerTOTPEvent = function (event, data, user) {\n    if (this.props.onTOTPEvent) {\n      this.props.onTOTPEvent(event, data, user);\n    }\n  };\n\n  TOTPSetupComp.prototype.handleInputChange = function (evt) {\n    this.setState({\n      setupMessage: null\n    });\n    this.inputs = {};\n    var _a = evt.target,\n        name = _a.name,\n        value = _a.value,\n        type = _a.type,\n        checked = _a.checked;\n    var check_type = ['radio', 'checkbox'].includes(type);\n    this.inputs[name] = check_type ? checked : value;\n  };\n\n  TOTPSetupComp.prototype.setup = function () {\n    var _this = this;\n\n    this.setState({\n      setupMessage: null\n    });\n    var user = this.props.authData;\n    var issuer = encodeURI(core_1.I18n.get('AWSCognito'));\n\n    if (!auth_1.default || typeof auth_1.default.setupTOTP !== 'function') {\n      throw new Error('No Auth module found, please ensure @aws-amplify/auth is imported');\n    }\n\n    auth_1.default.setupTOTP(user).then(function (data) {\n      logger.debug('secret key', data);\n      var code = \"otpauth://totp/\" + issuer + \":\" + user.username + \"?secret=\" + data + \"&issuer=\" + issuer;\n\n      _this.setState({\n        code: code\n      });\n    }).catch(function (err) {\n      return logger.debug('totp setup failed', err);\n    });\n  };\n\n  TOTPSetupComp.prototype.verifyTotpToken = function () {\n    var _this = this;\n\n    if (!this.inputs) {\n      logger.debug('no input');\n      return;\n    }\n\n    var user = this.props.authData;\n    var totpCode = this.inputs.totpCode;\n\n    if (!auth_1.default || typeof auth_1.default.verifyTotpToken !== 'function' || typeof auth_1.default.setPreferredMFA !== 'function') {\n      throw new Error('No Auth module found, please ensure @aws-amplify/auth is imported');\n    }\n\n    auth_1.default.verifyTotpToken(user, totpCode).then(function () {\n      // set it to preferred mfa\n      auth_1.default.setPreferredMFA(user, 'TOTP');\n\n      _this.setState({\n        setupMessage: 'Setup TOTP successfully!'\n      });\n\n      logger.debug('set up totp success!');\n\n      _this.triggerTOTPEvent('Setup TOTP', 'SUCCESS', user);\n    }).catch(function (err) {\n      _this.setState({\n        setupMessage: 'Setup TOTP failed!'\n      });\n\n      logger.error(err);\n    });\n  };\n\n  TOTPSetupComp.prototype.showSecretCode = function (code, theme) {\n    if (!code) return null;\n    return React.createElement(\"div\", null, React.createElement(\"div\", {\n      className: ui_1.totpQrcode\n    }, React.createElement(QRCode, {\n      value: code\n    })), React.createElement(Amplify_UI_Components_React_1.InputLabel, {\n      theme: theme\n    }, core_1.I18n.get('Enter Security Code:')), React.createElement(Amplify_UI_Components_React_1.Input, {\n      autoFocus: true,\n      theme: theme,\n      key: \"totpCode\",\n      name: \"totpCode\",\n      onChange: this.handleInputChange\n    }));\n  };\n\n  TOTPSetupComp.prototype.render = function () {\n    var theme = this.props.theme ? this.props.theme : Amplify_UI_Theme_1.default;\n    var code = this.state.code;\n    return React.createElement(Amplify_UI_Components_React_1.FormSection, {\n      theme: theme\n    }, this.state.setupMessage && React.createElement(Amplify_UI_Components_React_1.Toast, null, core_1.I18n.get(this.state.setupMessage)), React.createElement(Amplify_UI_Components_React_1.SectionHeader, {\n      theme: theme\n    }, core_1.I18n.get('Scan then enter verification code')), React.createElement(Amplify_UI_Components_React_1.SectionBody, {\n      theme: theme\n    }, this.showSecretCode(code, theme), this.state.setupMessage && core_1.I18n.get(this.state.setupMessage)), React.createElement(Amplify_UI_Components_React_1.SectionFooter, {\n      theme: theme\n    }, React.createElement(Amplify_UI_Components_React_1.Button, {\n      theme: theme,\n      onClick: this.verifyTotpToken,\n      style: {\n        width: '100%'\n      }\n    }, core_1.I18n.get('Verify Security Token'))));\n  };\n\n  return TOTPSetupComp;\n}(react_1.Component);\n\nexports.default = TOTPSetupComp;","map":null,"metadata":{},"sourceType":"script"}