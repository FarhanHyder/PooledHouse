{"ast":null,"code":"\"use strict\";\n/*\n * Copyright 2017-2017 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"). You may not use this file except in compliance with\n * the License. A copy of the License is located at\n *\n *     http://aws.amazon.com/apache2.0/\n *\n * or in the \"license\" file accompanying this file. This file is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR\n * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\n * and limitations under the License.\n */\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = Object.setPrototypeOf || {\n    __proto__: []\n  } instanceof Array && function (d, b) {\n    d.__proto__ = b;\n  } || function (d, b) {\n    for (var p in b) {\n      if (b.hasOwnProperty(p)) d[p] = b[p];\n    }\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar React = require(\"react\");\n\nvar react_1 = require(\"react\");\n\nvar core_1 = require(\"@aws-amplify/core\");\n\nvar storage_1 = require(\"@aws-amplify/storage\");\n\nvar Picker_1 = require(\"../Widget/Picker\");\n\nvar AmplifyTheme_1 = require(\"../AmplifyTheme\");\n\nvar S3Image_1 = require(\"./S3Image\");\n\nvar S3Text_1 = require(\"./S3Text\");\n\nvar logger = new core_1.ConsoleLogger('Storage.S3Album');\n\nvar S3Album =\n/** @class */\nfunction (_super) {\n  __extends(S3Album, _super);\n\n  function S3Album(props) {\n    var _this = _super.call(this, props) || this;\n\n    _this._isMounted = false;\n    _this.handlePick = _this.handlePick.bind(_this);\n    _this.handleClick = _this.handleClick.bind(_this);\n    _this.list = _this.list.bind(_this);\n    _this.marshal = _this.marshal.bind(_this);\n    _this.state = {\n      items: [],\n      ts: new Date().getTime()\n    };\n    return _this;\n  }\n\n  S3Album.prototype.getKey = function (file) {\n    var fileToKey = this.props.fileToKey;\n    var name = file.name,\n        size = file.size,\n        type = file.type;\n    var key = encodeURI(name);\n\n    if (fileToKey) {\n      var callback_type = typeof fileToKey;\n\n      if (callback_type === 'string') {\n        key = fileToKey;\n      } else if (callback_type === 'function') {\n        key = fileToKey({\n          name: name,\n          size: size,\n          type: type\n        });\n      } else {\n        key = encodeURI(JSON.stringify(fileToKey));\n      }\n\n      if (!key) {\n        logger.debug('key is empty');\n        key = 'empty_key';\n      }\n    }\n\n    return key.replace(/\\s/g, '_');\n  };\n\n  S3Album.prototype.handlePick = function (data) {\n    var _this = this;\n\n    var _a = this.props,\n        onPick = _a.onPick,\n        onLoad = _a.onLoad,\n        onError = _a.onError,\n        track = _a.track,\n        level = _a.level;\n\n    if (onPick) {\n      onPick(data);\n    }\n\n    var path = this.props.path || '';\n    var file = data.file,\n        name = data.name,\n        size = data.size,\n        type = data.type;\n    var key = path + this.getKey(data);\n\n    if (!storage_1.default || typeof storage_1.default.put !== 'function') {\n      throw new Error('No Storage module found, please ensure @aws-amplify/storage is imported');\n    }\n\n    storage_1.default.put(key, file, {\n      level: level ? level : 'public',\n      contentType: type,\n      track: track\n    }).then(function (data) {\n      logger.debug('handle pick data', data);\n      var items = _this.state.items;\n\n      if (items.filter(function (item) {\n        return item.key === key;\n      }).length === 0) {\n        var list = items.concat(data);\n\n        _this.marshal(list);\n      } else {\n        logger.debug('update an item');\n      }\n\n      if (onLoad) {\n        onLoad(data);\n      }\n    }).catch(function (err) {\n      logger.debug('handle pick error', err);\n\n      if (onError) {\n        onError(err);\n      }\n    });\n\n    if (this._isMounted) {\n      this.setState({\n        ts: new Date().getTime()\n      });\n    }\n  };\n\n  S3Album.prototype.handleClick = function (item) {\n    var _a = this.props,\n        onClickItem = _a.onClickItem,\n        select = _a.select,\n        onSelect = _a.onSelect;\n\n    if (onClickItem) {\n      onClickItem(item);\n    }\n\n    if (!select) {\n      return;\n    }\n\n    item.selected = !item.selected;\n\n    if (this._isMounted) {\n      this.setState({\n        items: this.state.items.slice()\n      });\n    }\n\n    if (!onSelect) {\n      return;\n    }\n\n    var selected_items = this.state.items.filter(function (item) {\n      return item.selected;\n    });\n    onSelect(item, selected_items);\n  };\n\n  S3Album.prototype.componentDidMount = function () {\n    this._isMounted = true;\n    this.list();\n  };\n\n  S3Album.prototype.componentWillUnmount = function () {\n    this._isMounted = false;\n  };\n\n  S3Album.prototype.componentDidUpdate = function (prevProps, prevState) {\n    if (this.props.path === prevProps.path && this.props.ts === prevProps.ts && this.props.select === prevProps.select) {\n      return;\n    }\n\n    if (!this.props.select) {\n      this.state.items.forEach(function (item) {\n        return item.selected = false;\n      });\n    }\n\n    if (this.props.onSelect) {\n      this.props.onSelect(null, []);\n    }\n\n    this.list();\n  };\n\n  S3Album.prototype.list = function () {\n    var _this = this;\n\n    var _a = this.props,\n        path = _a.path,\n        level = _a.level,\n        track = _a.track,\n        identityId = _a.identityId;\n    logger.debug('Album path: ' + path);\n\n    if (!storage_1.default || typeof storage_1.default.list !== 'function') {\n      throw new Error('No Storage module found, please ensure @aws-amplify/storage is imported');\n    }\n\n    return storage_1.default.list(path, {\n      level: level ? level : 'public',\n      track: track,\n      identityId: identityId\n    }).then(function (data) {\n      logger.debug('album list', data);\n\n      _this.marshal(data);\n    }).catch(function (err) {\n      logger.warn(err);\n      return [];\n    });\n  };\n\n  S3Album.prototype.contentType = function (item) {\n    return core_1.JS.filenameToContentType(item.key, 'image/*');\n  };\n\n  S3Album.prototype.marshal = function (list) {\n    var _this = this;\n\n    var contentType = this.props.contentType || '';\n    list.forEach(function (item) {\n      if (item.contentType) {\n        return;\n      }\n\n      var isString = typeof contentType === 'string';\n      item.contentType = isString ? contentType : contentType(item);\n\n      if (!item.contentType) {\n        item.contentType = _this.contentType(item);\n      }\n    });\n    var items = this.filter(list);\n    items = this.sort(items);\n\n    if (this._isMounted) {\n      this.setState({\n        items: items\n      });\n    }\n  };\n\n  S3Album.prototype.filter = function (list) {\n    var filter = this.props.filter;\n    return filter ? filter(list) : list;\n  };\n\n  S3Album.prototype.sort = function (list) {\n    var sort = this.props.sort;\n    var typeof_sort = typeof sort;\n\n    if (typeof_sort === 'function') {\n      return sort(list);\n    }\n\n    if (['string', 'undefined'].includes(typeof_sort)) {\n      var sort_str = sort ? sort : 'lastModified';\n      var parts = sort_str.split(/\\s+/);\n      var field = parts[0];\n      var dir = parts.length > 1 ? parts[1] : '';\n\n      if (field === 'lastModified') {\n        dir = dir === 'asc' ? 'asc' : 'desc';\n      } else {\n        dir = dir === 'desc' ? 'desc' : 'asc';\n      }\n\n      core_1.JS.sortByField(list, field, dir);\n      return list;\n    }\n\n    logger.warn('invalid sort. done nothing. should be a string or function');\n    return list;\n  };\n\n  S3Album.prototype.render = function () {\n    var _this = this;\n\n    var _a = this.props,\n        picker = _a.picker,\n        translateItem = _a.translateItem,\n        level = _a.level,\n        identityId = _a.identityId;\n    var _b = this.state,\n        items = _b.items,\n        ts = _b.ts;\n    var pickerTitle = this.props.pickerTitle || 'Pick';\n    var theme = this.props.theme || AmplifyTheme_1.default;\n    var list = items.map(function (item) {\n      var isText = item.contentType && core_1.JS.isTextFile(item.contentType);\n      return isText ? React.createElement(S3Text_1.default, {\n        key: item.key,\n        textKey: item.key,\n        theme: theme,\n        style: theme.albumText,\n        selected: item.selected,\n        translate: translateItem,\n        level: level,\n        identityId: identityId,\n        onClick: function onClick() {\n          return _this.handleClick(item);\n        }\n      }) : React.createElement(S3Image_1.default, {\n        key: item.key,\n        imgKey: item.key,\n        theme: theme,\n        style: theme.albumPhoto,\n        selected: item.selected,\n        translate: translateItem,\n        level: level,\n        identityId: identityId,\n        onClick: function onClick() {\n          return _this.handleClick(item);\n        }\n      });\n    });\n    return React.createElement(\"div\", null, React.createElement(\"div\", {\n      style: theme.album\n    }, list), picker ? React.createElement(Picker_1.default, {\n      key: ts,\n      title: pickerTitle,\n      accept: \"image/*, text/*\",\n      onPick: this.handlePick,\n      theme: theme\n    }) : null);\n  };\n\n  return S3Album;\n}(react_1.Component);\n\nexports.default = S3Album;","map":null,"metadata":{},"sourceType":"script"}